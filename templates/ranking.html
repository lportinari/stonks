{% extends "base.html" %}

{% block title %}Ranking de Ações - Stonks{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-trophy text-warning"></i> Ranking de Ações Bovespa</h1>
            <div>
                <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                <a href="{{ url_for('main.filter_stocks') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-filter"></i> Filtros
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Estatísticas -->
{% if stats %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title">Total de Ações</h5>
                <h3>{{ stats.total_stocks }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title">Score Médio</h5>
                <h3>{{ "%.1f"|format(stats.avg_score) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title">Score Máximo</h5>
                <h3>{{ "%.1f"|format(stats.top_score) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <h5 class="card-title">Setores</h5>
                <h3>{{ stats.sectors|length }}</h3>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Abas de Classes de Ativos -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-layer-group"></i> Ranking por Classe de Ativos</h5>
            </div>
            <div class="card-body p-0">
                <ul class="nav nav-tabs nav-fill" id="assetClassTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if not current_asset_class or current_asset_class == '' %}active{% endif %}" 
                                id="all-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#all" 
                                type="button" 
                                role="tab" 
                                aria-controls="all" 
                                aria-selected="{% if not current_asset_class or current_asset_class == '' %}true{% else %}false{% endif %}"
                                onclick="switchAssetClass('')">
                            <i class="fas fa-globe"></i> Todas as Classes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if current_asset_class == 'acao' %}active{% endif %}" 
                                id="acao-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#acao" 
                                type="button" 
                                role="tab" 
                                aria-controls="acao" 
                                aria-selected="{% if current_asset_class == 'acao' %}true{% else %}false{% endif %}"
                                onclick="switchAssetClass('acao')">
                            <i class="fas fa-chart-line"></i> Ações
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if current_asset_class == 'fii' %}active{% endif %}" 
                                id="fii-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#fii" 
                                type="button" 
                                role="tab" 
                                aria-controls="fii" 
                                aria-selected="{% if current_asset_class == 'fii' %}true{% else %}false{% endif %}"
                                onclick="switchAssetClass('fii')">
                            <i class="fas fa-building"></i> FIIs
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if current_asset_class == 'etf' %}active{% endif %}" 
                                id="etf-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#etf" 
                                type="button" 
                                role="tab" 
                                aria-controls="etf" 
                                aria-selected="{% if current_asset_class == 'etf' %}true{% else %}false{% endif %}"
                                onclick="switchAssetClass('etf')">
                            <i class="fas fa-folder"></i> ETFs
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if current_asset_class == 'bdr' %}active{% endif %}" 
                                id="bdr-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#bdr" 
                                type="button" 
                                role="tab" 
                                aria-controls="bdr" 
                                aria-selected="{% if current_asset_class == 'bdr' %}true{% else %}false{% endif %}"
                                onclick="switchAssetClass('bdr')">
                            <i class="fas fa-passport"></i> BDRs
                        </button>
                    </li>
                </ul>
                <div class="tab-content p-3" id="assetClassTabContent">
                    <div class="tab-pane fade {% if not current_asset_class or current_asset_class == '' %}show active{% endif %}" 
                         id="all" 
                         role="tabpanel" 
                         aria-labelledby="all-tab">
                        <div class="row">
                            <div class="col-md-4">
                                <h6><i class="fas fa-info-circle text-primary"></i> Todas as Classes</h6>
                                <p class="text-muted mb-0">Visualize todos os ativos disponíveis: Ações, FIIs, ETFs e BDRs em um único ranking.</p>
                            </div>
                            <div class="col-md-8 text-end">
                                {% if stats %}
                                <div class="d-inline-block text-start">
                                    <small class="text-muted">Estatísticas Gerais:</small><br>
                                    <strong>Total de Ativos:</strong> {{ stats.total_stocks }}<br>
                                    <strong>Score Médio:</strong> {{ "%.1f"|format(stats.avg_score) }}<br>
                                    <strong>Score Máximo:</strong> {{ "%.1f"|format(stats.top_score) }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade {% if current_asset_class == 'acao' %}show active{% endif %}" 
                         id="acao" 
                         role="tabpanel" 
                         aria-labelledby="acao-tab">
                        <div class="row">
                            <div class="col-md-8">
                                <h6><i class="fas fa-chart-line text-primary"></i> Ações</h6>
                                <p class="text-muted mb-0">Ações de empresas negociadas na B3. Ideal para investidores buscando crescimento e dividendos.</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-primary fs-6">AÇÕES</span><br>
                                <small class="text-muted">Mercado Tradicional</small><br>
                                {% if stats.asset_class == 'acao' and stats.total_stocks %}
                                <div class="mt-2">
                                    <strong>{{ stats.total_stocks }}</strong> ações<br>
                                    <small>Score Médio: {{ "%.1f"|format(stats.avg_score) }}</small><br>
                                    {% if stats.avg_pl %}
                                    <small>P/L Médio: {{ "%.1f"|format(stats.avg_pl) }}</small>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade {% if current_asset_class == 'fii' %}show active{% endif %}" 
                         id="fii" 
                         role="tabpanel" 
                         aria-labelledby="fii-tab">
                        <div class="row">
                            <div class="col-md-8">
                                <h6><i class="fas fa-building text-success"></i> Fundos Imobiliários (FIIs)</h6>
                                <p class="text-muted mb-0">Investimento em imóveis através de fundos. Excelente para renda mensal com isenção de imposto para pessoa física.</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-success fs-6">FIIs</span><br>
                                <small class="text-muted">Renda Mensal</small><br>
                                {% if stats.asset_class == 'fii' and stats.total_stocks %}
                                <div class="mt-2">
                                    <strong>{{ stats.total_stocks }}</strong> fundos<br>
                                    <small>Score Médio: {{ "%.1f"|format(stats.avg_score) }}</small><br>
                                    {% if stats.avg_dy %}
                                    <small>DY Médio: {{ "%.1f"|format(stats.avg_dy * 100) }}%</small>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade {% if current_asset_class == 'etf' %}show active{% endif %}" 
                         id="etf" 
                         role="tabpanel" 
                         aria-labelledby="etf-tab">
                        <div class="row">
                            <div class="col-md-8">
                                <h6><i class="fas fa-folder text-info"></i> ETFs (Exchange Traded Funds)</h6>
                                <p class="text-muted mb-0">Fundos de índice que acompanham benchmarks como Ibovespa. Diversificação simplificada com baixo custo.</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-info fs-6">ETFs</span><br>
                                <small class="text-muted">Fundos de Índice</small>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade {% if current_asset_class == 'bdr' %}show active{% endif %}" 
                         id="bdr" 
                         role="tabpanel" 
                         aria-labelledby="bdr-tab">
                        <div class="row">
                            <div class="col-md-8">
                                <h6><i class="fas fa-passport text-warning"></i> BDRs (Brazilian Depositary Receipts)</h6>
                                <p class="text-muted mb-0">Certificados que representam ações de empresas estrangeiras negociadas no Brasil. Acesso ao mercado global.</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-warning text-dark fs-6">BDRs</span><br>
                                <small class="text-muted">Mercado Global</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros Adicionais -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-search"></i> Buscar por Nome</h6>
            </div>
            <div class="card-body">
                <form method="GET" id="searchForm">
                    <input type="hidden" name="asset_class" id="assetClassInput" value="{{ current_asset_class or '' }}">
                    <input type="hidden" name="sector" id="sectorInput" value="{{ current_sector or '' }}">
                    <div class="input-group">
                        <input type="text" 
                               name="search" 
                               class="form-control" 
                               placeholder="Ticker ou Empresa..." 
                               value="{{ current_search or '' }}"
                               onkeyup="handleSearchKeyup(event)">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-industry"></i> Filtrar por Setor</h6>
            </div>
            <div class="card-body">
                <form method="GET" id="sectorForm">
                    <input type="hidden" name="asset_class" id="assetClassSectorInput" value="{{ current_asset_class or '' }}">
                    <input type="hidden" name="search" id="searchSectorInput" value="{{ current_search or '' }}">
                    <div class="input-group">
                        <select name="sector" class="form-select" onchange="document.getElementById('sectorForm').submit()">
                            <option value="">Todos os Setores</option>
                            {% for sector in sectors %}
                            <option value="{{ sector }}" {% if sector == current_sector %}selected{% endif %}>
                                {{ sector }}
                            </option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-filter"></i> Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Tabela de Ranking -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-chart-bar"></i> 
                    Ranking Completo
                    {% if current_sector %}- {{ current_sector }}{% endif %}
                </h5>
                <small class="text-muted">
                    {% if stocks %}Mostrando {{ stocks|length }} ações{% endif %}
                </small>
            </div>
            <div class="card-body">
                {% if stocks %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="rankingTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Posição</th>
                                <th>Logo</th>
                                <th>Ticker</th>
                                <th>Empresa</th>
                                <th>Classe</th>
                                <th class="indicator-value">Cotação</th>
                                <th class="indicator-value">Score</th>
                                <th class="indicator-value">DY</th>
                                <th class="indicator-value">P/L</th>
                                <th class="indicator-value">P/VP</th>
                                <th class="indicator-value">ROE</th>
                                <th class="indicator-value">Margem</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stock in stocks %}
                            <tr>
                                <td>
                                    <span class="rank-badge">{{ stock.rank_posicao }}</span>
                                </td>
                                <td>
                                    {% if stock.logo_url %}
                                        <img src="{{ stock.logo_url }}" alt="{{ stock.ticker }}" 
                                             class="stock-logo" onerror="this.src='https://ui-avatars.com/api/?name={{ stock.ticker }}&background=random&rounded=true'">
                                    {% else %}
                                        <img src="https://ui-avatars.com/api/?name={{ stock.ticker }}&background=random&rounded=true" 
                                             alt="{{ stock.ticker }}" class="stock-logo">
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ stock.ticker }}</strong>
                                </td>
                                <td>
                                    <small>{{ stock.empresa[:30] }}{% if stock.empresa|length > 30 %}...{% endif %}</small>
                                </td>
                                <td>
                                    <span class="badge {{ 'bg-primary' if stock.asset_class == 'acao' else 'bg-success' if stock.asset_class == 'fii' else 'bg-info' if stock.asset_class == 'etf' else 'bg-warning' }}">
                                        {{ stock.asset_class|upper if stock.asset_class else 'AÇÃO' }}
                                    </span>
                                </td>
                                <td class="indicator-value">
                                    {% if stock.cotacao %}
                                        R$ {{ "%.2f"|format(stock.cotacao) }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="indicator-value">
                                    <span class="stock-score {{ 'score-high' if stock.score_final and stock.score_final >= 70 else 'score-medium' if stock.score_final and stock.score_final >= 40 else 'score-low' }}">
                                        {{ "%.1f"|format(stock.score_final) if stock.score_final else '-' }}
                                    </span>
                                </td>
                                <td class="indicator-value">
                                    {% if stock.div_yield %}
                                        {{ "%.2f"|format(stock.div_yield * 100) }}%
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="indicator-value">
                                    {{ "%.2f"|format(stock.pl) if stock.pl else '-' }}
                                </td>
                                <td class="indicator-value">
                                    {{ "%.2f"|format(stock.pvp) if stock.pvp else '-' }}
                                </td>
                                <td class="indicator-value">
                                    {% if stock.roe %}
                                        {{ "%.2f"|format(stock.roe * 100) }}%
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="indicator-value">
                                    {% if stock.margem_liquida %}
                                        {{ "%.2f"|format(stock.margem_liquida * 100) }}%
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/detail/{{ stock.ticker }}" 
                                           class="btn btn-outline-primary" 
                                           data-bs-toggle="tooltip" title="Ver detalhes">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-outline-success" 
                                                onclick="addToCompare('{{ stock.ticker }}')"
                                                data-bs-toggle="tooltip" title="Adicionar à comparação">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhuma ação encontrada</h5>
                    <p class="text-muted">
                        {% if current_sector %}
                        Não há ações disponíveis para o setor {{ current_sector }}.
                        {% else %}
                        Não há ações disponíveis no momento. Tente atualizar os dados.
                        {% endif %}
                    </p>
                    <a href="{{ url_for('main.ranking') }}" class="btn btn-primary">
                        <i class="fas fa-trophy"></i> Voltar ao Ranking
                    </a>
                </div>
                {% endif %}
            </div>
            
            <!-- Paginação -->
            {% if stocks and stocks|length > 0 %}
            <div class="card-footer">
                <nav aria-label="Paginação do ranking">
                    <ul class="pagination justify-content-center mb-0">
                        <!-- Primeira página -->
                        {% if page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.ranking', page=1, sector=current_sector, asset_class=current_asset_class, search=current_search, per_page=per_page) }}">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                        </li>
                        {% endif %}
                        
                        <!-- Página anterior -->
                        {% if page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.ranking', page=page-1, sector=current_sector, asset_class=current_asset_class, search=current_search, per_page=per_page) }}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="fas fa-angle-left"></i></span>
                        </li>
                        {% endif %}
                        
                        <!-- Número de páginas -->
                        {% set total_pages = ((stats.total_stocks or stocks|length) / per_page)|round(0, 'ceil')|int %}
                        {% set start_page = [1, page - 2]|max %}
                        {% set end_page = [total_pages, page + 2]|min %}
                        
                        {% if start_page > 1 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% endif %}
                        
                        {% for p in range(start_page, end_page + 1) %}
                        {% if p == page %}
                        <li class="page-item active">
                            <span class="page-link">{{ p }}</span>
                        </li>
                        {% else %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.ranking', page=p, sector=current_sector, asset_class=current_asset_class, search=current_search, per_page=per_page) }}">{{ p }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}
                        
                        {% if end_page < total_pages %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% endif %}
                        
                        <!-- Próxima página -->
                        {% if page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.ranking', page=page+1, sector=current_sector, asset_class=current_asset_class, search=current_search, per_page=per_page) }}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="fas fa-angle-right"></i></span>
                        </li>
                        {% endif %}
                        
                        <!-- Última página -->
                        {% if page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.ranking', page=total_pages, sector=current_sector, asset_class=current_asset_class, search=current_search, per_page=per_page) }}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                
                <!-- Controles de itens por página -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <label class="me-2">Itens por página:</label>
                            <select class="form-select form-select-sm" style="width: auto;" onchange="changePerPage(this.value)">
                                <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                                <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <small class="text-muted">
                            {% if stats.total_stocks %}
                            Página {{ page }} de {{ total_pages }} ({{ stats.total_stocks }} ações no total)
                            {% else %}
                            Página {{ page }} ({{ stocks|length }} ações)
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de Comparação -->
<div class="modal fade" id="compareModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Comparar Ações</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Ações selecionadas para comparação:</p>
                <div id="compareList" class="mb-3"></div>
                <button class="btn btn-primary" onclick="compareSelected()">Comparar Selecionadas</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let compareList = [];
const MAX_COMPARE = 5;

// Função para trocar entre classes de ativos
function switchAssetClass(assetClass) {
    const url = new URL(window.location);
    
    // Atualizar o parâmetro asset_class
    if (assetClass === '' || assetClass === null || assetClass === undefined) {
        url.searchParams.delete('asset_class');
    } else {
        url.searchParams.set('asset_class', assetClass);
    }
    
    // Manter outros parâmetros
    url.searchParams.set('page', '1'); // Resetar para primeira página
    
    // Salvar preferência no localStorage
    if (assetClass) {
        localStorage.setItem('preferredAssetClass', assetClass);
    } else {
        localStorage.removeItem('preferredAssetClass');
    }
    
    // Redirecionar para nova URL
    window.location.href = url.toString();
}

// Função para tratar Enter no campo de busca
function handleSearchKeyup(event) {
    if (event.key === 'Enter') {
        document.getElementById('searchForm').submit();
    }
}

// Função para atualizar formulários com a classe atual
function updateFormsWithAssetClass() {
    const currentAssetClass = new URLSearchParams(window.location.search).get('asset_class') || '';
    
    // Atualizar inputs hidden nos formulários
    const assetClassInputs = document.querySelectorAll('[id^="assetClass"]');
    assetClassInputs.forEach(input => {
        input.value = currentAssetClass;
    });
}

// Inicialização quando a página carrega
document.addEventListener('DOMContentLoaded', function() {
    // Atualizar formulários
    updateFormsWithAssetClass();
    
    // Restaurar preferência de aba se não houver nenhuma selecionada
    const urlParams = new URLSearchParams(window.location.search);
    if (!urlParams.has('asset_class')) {
        const preferredAssetClass = localStorage.getItem('preferredAssetClass');
        if (preferredAssetClass) {
            // Não redirecionar automaticamente para evitar loops
            // Apenas mostrar visualmente qual aba estaria ativa
        }
    }
    
    // Manter sincronização entre as abas Bootstrap e a URL
    const tabs = document.querySelectorAll('#assetClassTabs button[onclick]');
    tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            // Prevenir comportamento padrão se necessário
            const assetClass = this.getAttribute('onclick').match(/switchAssetClass\('(.*)'\)/);
            if (assetClass) {
                e.preventDefault();
                switchAssetClass(assetClass[1]);
            }
        });
    });
    
    // Adicionar tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Mostrar loading em links AJAX
    document.querySelectorAll('a[data-ajax]').forEach(link => {
        link.addEventListener('click', function(e) {
            showLoading();
        });
    });
});

function addToCompare(ticker) {
    if (compareList.includes(ticker)) {
        showToast(`${ticker} já está na lista de comparação`, 'warning');
        return;
    }
    
    if (compareList.length >= MAX_COMPARE) {
        showToast(`Máximo de ${MAX_COMPARE} ações por comparação`, 'warning');
        return;
    }
    
    compareList.push(ticker);
    updateCompareList();
    showToast(`${ticker} adicionado à comparação`, 'success');
}

function removeFromCompare(ticker) {
    compareList = compareList.filter(t => t !== ticker);
    updateCompareList();
}

function updateCompareList() {
    const listEl = document.getElementById('compareList');
    if (compareList.length === 0) {
        listEl.innerHTML = '<p class="text-muted">Nenhuma ação selecionada</p>';
        return;
    }
    
    let html = '<div class="d-flex flex-wrap gap-2">';
    compareList.forEach(ticker => {
        html += `
            <span class="badge bg-primary d-flex align-items-center">
                ${ticker}
                <button type="button" class="btn-close btn-close-white ms-2" 
                        onclick="removeFromCompare('${ticker}')"></button>
            </span>
        `;
    });
    html += '</div>';
    listEl.innerHTML = html;
}

function compareSelected() {
    if (compareList.length < 2) {
        showToast('Selecione pelo menos 2 ações para comparar', 'warning');
        return;
    }
    
    const url = `/compare?tickers=${compareList.join(',')}`;
    window.location.href = url;
}

// Ordenação da tabela
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('rankingTable');
    if (table) {
        // Adicionar ordenação clicável nos cabeçalhos
        const headers = table.querySelectorAll('th');
        headers.forEach((header, index) => {
            if (index > 0 && index < 11) { // Excluir posição e ações
                header.style.cursor = 'pointer';
                header.addEventListener('click', () => sortTable(table, index));
            }
        });
    }
});

function sortTable(table, columnIndex) {
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    const isNumeric = columnIndex >= 4; // Colunas de indicadores são numéricas
    
    rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].textContent.trim();
        const bValue = b.cells[columnIndex].textContent.trim();
        
        if (isNumeric) {
            const aNum = parseFloat(aValue.replace(/[^0-9.-]/g, '')) || 0;
            const bNum = parseFloat(bValue.replace(/[^0-9.-]/g, '')) || 0;
            return bNum - aNum; // Ordenar decrescente para números
        } else {
            return aValue.localeCompare(bValue);
        }
    });
    
    // Reorganizar linhas
    rows.forEach(row => tbody.appendChild(row));
}

// Mudar itens por página
function changePerPage(perPage) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', perPage);
    url.searchParams.set('page', '1'); // Voltar para primeira página
    window.location.href = url.toString();
}

// Exportar dados
function exportData(format) {
    if (format === 'csv') {
        const table = document.getElementById('rankingTable');
        let csv = [];
        
        // Headers
        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
        csv.push(headers.join(','));
        
        // Data
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const values = Array.from(row.cells).map(cell => cell.textContent.trim());
            csv.push(values.join(','));
        });
        
        const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ranking_acoes.csv';
        a.click();
    }
}
</script>
{% endblock %}