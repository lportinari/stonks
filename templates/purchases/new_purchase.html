{% extends "base.html" %}

{% block title %}Nova Compra - Stonks{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Coluna Principal - Formulário -->
        <div class="col-lg-8">
            <!-- Card Principal -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-gradient-success text-white py-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h4 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Nova Compra</h4>
                            <small class="text-white-50">Registre uma nova aquisição de ativos</small>
                        </div>
                        <i class="fas fa-plus-circle fa-2x text-white-50"></i>
                    </div>
                </div>
                <div class="card-body p-4">
                    <form method="POST" id="purchaseForm" novalidate class="needs-validation">
                        <!-- Seção: Informações Básicas -->
                        <div class="mb-4">
                            <h6 class="text-success mb-3">
                                <i class="fas fa-info-circle me-2"></i>Informações Básicas
                            </h6>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="ticker" class="form-label fw-semibold">
                                        Ticker <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-light">
                                            <i class="fas fa-tag text-success"></i>
                                        </span>
                                        <input type="text" class="form-control" id="ticker" name="ticker" 
                                               value="{{ dados.ticker or '' }}" 
                                               placeholder="Ex: PETR4 ou Tesouro Selic 2031" required>
                                    </div>
                                    <div class="form-text text-muted">
                                        Informe o código do ativo (ex: PETR4, Tesouro Selic 2031, BTC)
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="data_compra" class="form-label fw-semibold">
                                        Data da Compra <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-light">
                                            <i class="fas fa-calendar-alt text-success"></i>
                                        </span>
                                        <input type="date" class="form-control" id="data_compra" 
                                               name="data_compra" 
                                               value="{{ request.form.data_compra or today }}" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seção: Classificação -->
                        <div class="mb-4">
                            <h6 class="text-success mb-3">
                                <i class="fas fa-layer-group me-2"></i>Classificação
                            </h6>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="classe_ativo" class="form-label fw-semibold">
                                        Classe do Ativo <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-light">
                                            <i class="fas fa-folder-open text-success"></i>
                                        </span>
                                        <select class="form-select" id="classe_ativo" name="classe_ativo" required>
                                            <option value="">Selecione a classe...</option>
                                            <option value="acoes" {{ 'selected' if dados.get('classe_ativo') == 'acoes' else '' }}>
                                                <i class="fas fa-chart-line me-2"></i>Ações
                                            </option>
                                            <option value="renda_fixa_pos" {{ 'selected' if dados.get('classe_ativo') == 'renda_fixa_pos' else '' }}>
                                                Renda Fixa Pós
                                            </option>
                                            <option value="renda_fixa_dinamica" {{ 'selected' if dados.get('classe_ativo') == 'renda_fixa_dinamica' else '' }}>
                                                Renda Fixa Dinâmica
                                            </option>
                                            <option value="fundos_imobiliarios" {{ 'selected' if dados.get('classe_ativo') == 'fundos_imobiliarios' else '' }}>
                                                Fundos Imobiliários
                                            </option>
                                            <option value="internacional" {{ 'selected' if dados.get('classe_ativo') == 'internacional' else '' }}>
                                                Internacional
                                            </option>
                                            <option value="fundos_multimercados" {{ 'selected' if dados.get('classe_ativo') == 'fundos_multimercados' else '' }}>
                                                Fundos Multimercados
                                            </option>
                                            <option value="alternativos" {{ 'selected' if dados.get('classe_ativo') == 'alternativos' else '' }}>
                                                Alternativos
                                            </option>
                                        </select>
                                    </div>
                                    <div class="form-text text-muted">
                                        Selecione a categoria para melhor organização
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seção: Detalhes da Transação -->
                        <div class="mb-4">
                            <h6 class="text-success mb-3">
                                <i class="fas fa-exchange-alt me-2"></i>Detalhes da Transação
                            </h6>
                            
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="quantidade" class="form-label fw-semibold">
                                        Quantidade <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <input type="text" class="form-control text-end" id="quantidade" 
                                               name="quantidade" value="{{ request.form.quantidade or '' }}" 
                                               placeholder="0,03" required>
                                        <span class="input-group-text bg-light">unidades</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="preco_unitario" class="form-label fw-semibold">
                                        Preço Unitário <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-light">R$</span>
                                        <input type="text" class="form-control text-end" id="preco_unitario" 
                                               name="preco_unitario" value="{{ request.form.preco_unitario or '' }}" 
                                               placeholder="16,76" required>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="taxas" class="form-label fw-semibold">
                                        Taxas e Custos
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-light">R$</span>
                                        <input type="text" class="form-control text-end" id="taxas" 
                                               name="taxas" value="{{ request.form.taxas or '0,00' }}" 
                                               placeholder="0,00">
                                    </div>
                                    <div class="form-text text-muted small">
                                        Corretagem, emolumentos, etc.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botões de Ação -->
                        <div class="row mt-4 pt-3 border-top">
                            <div class="col-12 text-end">
                                <a href="{{ url_for('purchases.index') }}" class="btn btn-outline-secondary btn-lg me-2">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </a>
                                <button type="submit" class="btn btn-success btn-lg px-5" id="btnSalvar">
                                    <i class="fas fa-save me-2"></i>Registrar Compra
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Coluna Lateral - Resumo e Informações -->
        <div class="col-lg-4">
            <!-- Card de Resumo -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-success text-white py-3">
                    <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Resumo da Compra</h6>
                </div>
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Subtotal</span>
                        <h5 class="mb-0 text-primary" id="subtotal">R$ 0,00</h5>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Taxas</span>
                        <h5 class="mb-0 text-warning" id="taxasDisplay">R$ 0,00</h5>
                    </div>
                    <hr class="my-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted fw-semibold">Total</span>
                        <h4 class="mb-0 text-success" id="total">R$ 0,00</h4>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Preço Médio</span>
                        <h5 class="mb-0 text-info" id="precoMedio">R$ 0,00</h5>
                    </div>
                </div>
            </div>

            <!-- Card de Dicas -->
            <div class="card shadow-sm border-0 bg-light">
                <div class="card-body p-4">
                    <h6 class="text-success mb-3">
                        <i class="fas fa-lightbulb me-2"></i>Dicas Importantes
                    </h6>
                    <ul class="list-unstyled mb-0 small text-muted">
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Verifique o ticker corretamente antes de confirmar
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Selecione a classe do ativo apropriada
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Inclua todas as taxas para cálculo preciso
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            O preço médio é calculado automaticamente
                        </li>
                        <li>
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Dados do ativo são buscados automaticamente
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Loading -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <div class="spinner-border text-success mb-3" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <h5 class="mb-2" id="loadingTitle">Processando...</h5>
            <p class="text-muted mb-0" id="loadingMessage">Por favor, aguarde.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('purchaseForm');
    const tickerInput = document.getElementById('ticker');
    const quantidadeInput = document.getElementById('quantidade');
    const precoInput = document.getElementById('preco_unitario');
    const taxasInput = document.getElementById('taxas');
    const btnSalvar = document.getElementById('btnSalvar');
    
    // Calcular totais automaticamente
    function calcularTotais() {
        // Normalizar valores numéricos (substituir vírgula por ponto e remover caracteres não numéricos exceto . e -)
        const normalizeNumber = (value) => {
            if (!value) return 0;
            // Substituir vírgula por ponto e remover tudo exceto números, ponto e sinal negativo
            const cleaned = value.toString().replace(',', '.').replace(/[^\d.-]/g, '');
            return parseFloat(cleaned) || 0;
        };
        
        const quantidade = normalizeNumber(quantidadeInput.value);
        const preco = normalizeNumber(precoInput.value);
        const taxas = normalizeNumber(taxasInput.value);
        
        const subtotal = quantidade * preco;
        const total = subtotal + taxas;
        const precoMedio = quantidade > 0 ? total / quantidade : 0;
        
        document.getElementById('subtotal').textContent = formatCurrency(subtotal);
        document.getElementById('taxasDisplay').textContent = formatCurrency(taxas);
        document.getElementById('total').textContent = formatCurrency(total);
        document.getElementById('precoMedio').textContent = formatCurrency(precoMedio);
    }
    
    function formatCurrency(value) {
        // Formatar com vírgula como separador decimal
        return 'R$ ' + value.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Formatar input com vírgula automaticamente
    function formatInputWithComma(input) {
        let value = input.value;
        // Permitir apenas números, vírgula e ponto
        value = value.replace(/[^\d.,]/g, '');
        // Remover pontos (separadores de milhar brasileiro)
        value = value.replace(/\./g, '');
        // Manter apenas a primeira vírgula (separador decimal)
        const parts = value.split(',');
        if (parts.length > 1) {
            value = parts[0] + ',' + parts.slice(1).join('');
        }
        input.value = value;
    }
    
    // Adicionar formatação e cálculo nos campos numéricos
    quantidadeInput.addEventListener('input', function() {
        formatInputWithComma(this);
        calcularTotais();
    });
    
    precoInput.addEventListener('input', function() {
        formatInputWithComma(this);
        calcularTotais();
    });
    
    taxasInput.addEventListener('input', function() {
        formatInputWithComma(this);
        calcularTotais();
    });
    
    // Funções do modal de loading
    function showLoading(title, message) {
        document.getElementById('loadingTitle').textContent = title;
        document.getElementById('loadingMessage').textContent = message;
        const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
        modal.show();
    }
    
    function hideLoading() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
        if (modal) {
            modal.hide();
        }
    }
    
    // Validação e envio do formulário
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!form.checkValidity()) {
            e.stopPropagation();
            form.classList.add('was-validated');
            return;
        }
        
        const ticker = tickerInput.value.trim().toUpperCase();
        
        if (!ticker) {
            alert('Por favor, informe o ticker do ativo.');
            tickerInput.focus();
            return;
        }
        
        showLoading('Registrando Compra', 'Salvando informações...');
        
        btnSalvar.disabled = true;
        btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Registrando...';
        
        // Enviar formulário
        setTimeout(() => {
            form.submit();
        }, 1000);
    });
    
    // Formatar ticker automaticamente
    tickerInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });
    
    // Calcular totais iniciais
    calcularTotais();
    
    // Auto-focus no ticker
    tickerInput.focus();
});
</script>
{% endblock %}